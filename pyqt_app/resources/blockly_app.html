<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Robot Blockly Workspace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #app { display: flex; flex-direction: column; height: 100%; }
        #workspace { position: relative; display: flex; flex-direction: column; flex: 1 1 auto; min-height: 0; }
        #log-panel { border-top: 1px solid #ccc; padding: 12px; box-sizing: border-box; flex: 0 0 140px; display: flex; flex-direction: column; }
        #log-panel h2 { margin: 0 0 8px; }
        #log { white-space: pre-wrap; word-break: break-word; flex: 1 1 auto; margin: 0; overflow-y: auto; }
        .button-row { margin: 10px 6px; display: flex; gap: 8px; flex-wrap: wrap; }
        button { padding: 8px 12px; }
        #blocklyDiv { flex: 1 1 auto; width: 100%; min-height: 0; }
    </style>
    <link rel="stylesheet" href="vendor/blockly/blockly.css">
    <script src="blockly_loader.js"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
</head>
<body>
    <div id="app">
        <div id="workspace">
            <div class="button-row">
                <button id="btn-clear">Clear Workspace</button>
                <button id="btn-zoom-in" title="Zoom in">Zoom In</button>
                <button id="btn-zoom-out" title="Zoom out">Zoom Out</button>
            </div>
            <div id="blocklyDiv"></div>
            <xml id="toolbox" style="display: none"></xml>
        </div>
        <div id="log-panel">
            <h4>Status</h4>
            <pre id="log">Initializing…</pre>
        </div>
    </div>
    <script>
        let bridge = null;
        let workspace = null;

        function initChannel() {
            new QWebChannel(qt.webChannelTransport, function(channel) {
                bridge = channel.objects.robotBridge;
                appendLog('Bridge connected.');
                emitWorkspace();
            });
        }

        function initBlockly() {
            if (typeof Blockly === 'undefined') {
                appendLog('Blockly library is unavailable. Check network access or bundle a local copy.');
                return;
            }
            if (!Blockly.RobotToolbox) {
                appendLog('Toolbox not ready yet. Retrying...');
                setTimeout(initBlockly, 50);
                return;
            }
            const toolboxSource = Blockly.RobotToolbox;
            const toolboxDef = typeof toolboxSource === 'string'
                ? JSON.parse(toolboxSource)
                : toolboxSource;
            workspace = Blockly.inject('blocklyDiv', {
                toolbox: toolboxDef,
                scrollbars: true,
                trashcan: true,
                renderer: 'zelos',
                media: 'vendor/blockly/media/'
            });

            workspace.addChangeListener(handleWorkspaceChange);
            appendLog('Workspace ready.');
            emitWorkspace();
        }

        function handleWorkspaceChange(event) {
            if (event.type === Blockly.Events.BLOCK_CREATE) {
                // Preserve deterministic IDs for custom block lookups.
                const block = workspace.getBlockById(event.blockId);
                if (block) {
                    block.data = block.id;
                }
            }
            if (event.type !== Blockly.Events.VIEWPORT_CHANGE) {
                emitWorkspace();
            }
        }

        function emitWorkspace() {
            if (!bridge || !workspace || !Blockly || !Blockly.Python) {
                return;
            }
            try {
                const pythonCode = Blockly.Python.workspaceToCode(workspace);
                bridge.updatePythonCode(pythonCode);
                appendLog('Python code updated.');
            } catch (err) {
                appendLog('Python generation error: ' + err);
            }
        }

        function appendLog(message) {
            const log = document.getElementById('log');
            log.textContent = message;
        }

        document.getElementById('btn-clear').addEventListener('click', function() {
            workspace.clear();
        });

        document.getElementById('btn-zoom-in').addEventListener('click', function() {
            if (!workspace) { return; }
            workspace.zoomCenter(1);
        });

        document.getElementById('btn-zoom-out').addEventListener('click', function() {
            if (!workspace) { return; }
            workspace.zoomCenter(-1);
        });

        window.addEventListener('RobotBlocklyReady', function() {
            initBlockly();
        });

        window.addEventListener('RobotBlocklyFailed', function() {
            appendLog('Failed to load Blockly assets.');
        });

        document.addEventListener('DOMContentLoaded', function() {
            appendLog('Loading Blockly assets…');
            initChannel();
        });
    </script>
</body>
</html>
